name: Deploy to Vercel

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼ˆæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'vercel.json'
      - '.github/workflows/deploy-vercel.yml'
  
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'vercel.json'

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¸ãƒ§ãƒ–
  process-data:
    name: ãƒ‡ãƒ¼ã‚¿å‡¦ç†
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r requirements.txt
      
      - name: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®å®Ÿè¡Œ
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          python scripts/main.py
        continue-on-error: true
      
      - name: å‡¦ç†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: frontend/public/data/
          retention-days: 1
          if-no-files-found: warn

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–
  deploy:
    name: Vercelãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [process-data]
    if: always() && (needs.process-data.result == 'success' || needs.process-data.result == 'skipped')
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: å‡¦ç†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: frontend/public/data/
        continue-on-error: true
      
      - name: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        run: |
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª ==="
          if [ -d "frontend/public/data" ]; then
            find frontend/public/data -name "*.json" | head -10
            echo "JSONãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find frontend/public/data -name "*.json" | wc -l)"
          else
            echo "ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            mkdir -p frontend/public/data/news
            mkdir -p frontend/public/data/summaries
            echo '[]' > frontend/public/data/news/latest.json
            echo '{"date":"","total_articles":0,"top_trends":[],"significant_news":[],"category_breakdown":{},"summary_ja":"ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­ã§ã™","summary_en":"Data is being prepared","generated_at":""}' > frontend/public/data/summaries/latest.json
          fi
      
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd frontend
          npm ci --production=false
      
      - name: TypeScriptã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
        run: |
          cd frontend
          npm run type-check
      
      - name: ESLintãƒã‚§ãƒƒã‚¯
        run: |
          cd frontend
          npm run lint
        continue-on-error: true
      
      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          cd frontend
          npm test -- --passWithNoTests
        continue-on-error: true
      
      - name: Vercel CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install --global vercel@latest
      
      - name: Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®å–å¾—
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
        run: |
          cd frontend
          npm run build:vercel
      
      - name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preview')
        run: |
          vercel deploy --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV
      
      - name: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
        if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
        run: |
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          echo "DEPLOYMENT_URL=$(cat deployment-url.txt)" >> $GITHUB_ENV
      
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®ç¢ºèª
        run: |
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“ URL: ${{ env.DEPLOYMENT_URL }}"
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          if curl -f -s "${{ env.DEPLOYMENT_URL }}" > /dev/null; then
            echo "âœ… ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
          else
            echo "âš ï¸ ã‚µã‚¤ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi
      
      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Vercelãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼**
              
              ğŸ“ **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${{ env.DEPLOYMENT_URL }}
              
              ğŸ” **å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„**
              - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª
              - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¢ºèª
              - ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®ç¢ºèª
              
              âš¡ **è‡ªå‹•ãƒã‚§ãƒƒã‚¯çµæœ**
              - âœ… TypeScriptã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
              - âœ… ESLintãƒã‚§ãƒƒã‚¯
              - âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ
              - âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ`
            })

  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ†ã‚¹ãƒˆ
  post-deploy-test:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: E2Eãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps
      
      - name: E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          cd frontend
          PLAYWRIGHT_BASE_URL="${{ env.DEPLOYMENT_URL }}" npx playwright test
        continue-on-error: true
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7