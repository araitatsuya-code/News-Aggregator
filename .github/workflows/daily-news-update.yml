name: Daily News Update

on:
  # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ = UTC 0æ™‚
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if recent data exists'
        required: false
        default: 'false'
        type: boolean

env:
  CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
  PYTHON_VERSION: '3.13'

jobs:
  update-news:
    runs-on: ubuntu-latest
    timeout-minutes: 90   # 1.5æ™‚é–“ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆèª²é‡‘å¯¾ç­–ï¼‰
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify Claude API key
        run: |
          if [ -z "$CLAUDE_API_KEY" ]; then
            echo "âŒ CLAUDE_API_KEY is not set in GitHub Secrets"
            echo "Please add your Claude API key to repository secrets:"
            echo "1. Go to Settings > Secrets and variables > Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: CLAUDE_API_KEY"
            echo "4. Value: your_claude_api_key_here"
            exit 1
          fi
          echo "âœ… Claude API key is configured"
          
      - name: Check for recent data
        id: check-data
        run: |
          TODAY=$(date +%Y-%m-%d)
          DATA_FILE="frontend/public/data/news/$TODAY/articles.json"
          
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "ğŸ”„ Force update requested"
            echo "should_update=true" >> $GITHUB_OUTPUT
          elif [ -f "$DATA_FILE" ]; then
            ARTICLES_COUNT=$(jq '. | length' "$DATA_FILE")
            if [ "$ARTICLES_COUNT" -gt 50 ]; then
              echo "âœ… Recent data exists ($ARTICLES_COUNT articles), skipping update"
              echo "should_update=false" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Data exists but insufficient ($ARTICLES_COUNT articles), updating"
              echo "should_update=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“° No data for today, starting news collection"
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Create data directories
        if: steps.check-data.outputs.should_update == 'true'
        run: |
          mkdir -p frontend/public/data/{news,summaries,config,metrics}
          mkdir -p logs
          echo "ğŸ“ Data directories created"
          
      - name: Collect news data
        if: steps.check-data.outputs.should_update == 'true'
        run: |
          echo "ğŸš€ Starting news collection..."
          timeout 5400 python scripts/main.py || {
            exit_code=$?
            if [ $exit_code -eq 124 ]; then
              echo "â° News collection timed out after 1.5 hours"
              exit 1
            else
              echo "âŒ News collection failed with exit code $exit_code"
              exit $exit_code
            fi
          }
          echo "âœ… News collection completed"
          
      - name: Verify collected data
        if: steps.check-data.outputs.should_update == 'true'
        run: |
          TODAY=$(date +%Y-%m-%d)
          ARTICLES_FILE="frontend/public/data/news/$TODAY/articles.json"
          LATEST_FILE="frontend/public/data/news/latest.json"
          
          if [ ! -f "$ARTICLES_FILE" ]; then
            echo "âŒ Articles file not found: $ARTICLES_FILE"
            exit 1
          fi
          
          ARTICLES_COUNT=$(jq '. | length' "$ARTICLES_FILE" 2>/dev/null || echo "0")
          
          if [ "$ARTICLES_COUNT" -lt 30 ]; then
            echo "âš ï¸  Warning: Only $ARTICLES_COUNT articles collected"
          else
            echo "âœ… Successfully collected $ARTICLES_COUNT articles"
          fi
          
          # latest.jsonæ›´æ–°
          cp "$ARTICLES_FILE" "$LATEST_FILE"
          echo "ğŸ“„ Updated latest.json with $ARTICLES_COUNT articles"
          
      - name: Generate sitemap and feeds
        if: steps.check-data.outputs.should_update == 'true'
        run: |
          cd frontend
          npm ci
          npm run generate-sitemap
          echo "ğŸ—ºï¸  Sitemap and RSS feeds generated"
          
      - name: Commit and push changes
        if: steps.check-data.outputs.should_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          TODAY=$(date +%Y-%m-%d)
          ARTICLES_COUNT=$(jq '. | length' "frontend/public/data/news/$TODAY/articles.json" 2>/dev/null || echo "0")
          
          # å¤‰æ›´ãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¿½åŠ 
          git add frontend/public/data/
          git add frontend/public/sitemap.xml
          git add frontend/public/rss*.xml
          git add frontend/public/robots.txt
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --cached --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            # ã‚³ãƒŸãƒƒãƒˆ
            git commit -m "feat: è‡ªå‹•ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–° ($TODAY) - $ARTICLES_COUNT è¨˜äº‹

ğŸ“Š åé›†çµ±è¨ˆ:
- æ—¥ä»˜: $TODAY  
- è¨˜äº‹æ•°: $ARTICLES_COUNT
- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')

ğŸ¤– Automated update via GitHub Actions"

            # ãƒ—ãƒƒã‚·ãƒ¥
            git push
            echo "âœ… Changes committed and pushed successfully"
          fi
          
      - name: Update deployment status
        if: always()
        run: |
          if [ "${{ steps.check-data.outputs.should_update }}" = "false" ]; then
            echo "â„¹ï¸  News update skipped - recent data available"
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Daily news update completed successfully"
          else
            echo "âŒ Daily news update failed"
          fi
          
      - name: Upload logs
        if: always() && steps.check-data.outputs.should_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: news-update-logs
          path: |
            logs/
            frontend/public/data/metrics/
          retention-days: 7
          
  # Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼ï¼ˆå¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰
  trigger-deployment:
    needs: update-news
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Trigger Vercel deployment
        run: |
          echo "ğŸš€ News update completed - Vercel will automatically deploy the changes"
          echo "ğŸ“¡ Deployment status: https://vercel.com/dashboard"