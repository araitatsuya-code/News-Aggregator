# 設計書

## 概要

ワンコマンドデプロイメント機能は、現在手動で実行している複数のステップを統合し、シェルスクリプトベースの自動化ツールとして実装します。Makefileとの統合により、開発者が簡単にワークフロー全体を実行できるようにします。

## アーキテクチャ

### システム構成

```
scripts/
├── deploy-full.sh          # メインのワンコマンドデプロイスクリプト
├── deploy-data-only.sh     # データ準備のみのスクリプト
├── deploy-vercel-only.sh   # Vercelデプロイのみのスクリプト（既存を拡張）
└── utils/
    ├── venv-manager.sh     # 仮想環境管理ユーティリティ
    ├── progress-logger.sh  # 進行状況表示ユーティリティ
    └── time-tracker.sh     # 実行時間計測ユーティリティ
```

### ワークフロー設計

#### フルデプロイワークフロー
1. **環境確認**: 仮想環境の存在確認と有効化
2. **データ収集**: `python3 scripts/main.py` の実行
3. **データコピー**: latest.jsonファイルの更新
4. **デプロイ**: Vercelへのデプロイ実行
5. **完了報告**: 実行時間とサマリーの表示

#### データ準備ワークフロー
1. **環境確認**: 仮想環境の存在確認と有効化
2. **データ収集**: `python3 scripts/main.py` の実行
3. **データコピー**: latest.jsonファイルの更新
4. **統計表示**: 生成されたデータの統計情報表示

## コンポーネントと インターフェース

### 1. メインデプロイスクリプト (deploy-full.sh)

```bash
#!/bin/bash
# 使用方法: ./scripts/deploy-full.sh [--env preview|prod] [--skip-data] [--verbose]

主要機能:
- コマンドライン引数の解析
- 各ステップの順次実行
- エラーハンドリングと中断処理
- 実行時間の計測と表示
```

### 2. 仮想環境マネージャー (venv-manager.sh)

```bash
#!/bin/bash
# 仮想環境の検出、有効化、検証を行う

主要機能:
- venv/bin/activateの存在確認
- 仮想環境の自動有効化
- Python環境の検証
- 依存関係の確認
```

### 3. 進行状況ロガー (progress-logger.sh)

```bash
#!/bin/bash
# 進行状況の表示とログ出力を行う

主要機能:
- ステップ進行状況の表示
- リアルタイムログ出力
- エラー情報の記録
- 実行サマリーの生成
```

### 4. 時間トラッカー (time-tracker.sh)

```bash
#!/bin/bash
# 実行時間の計測と表示を行う

主要機能:
- ステップ別実行時間の計測
- 総実行時間の計算
- 時間情報のフォーマット表示
- パフォーマンス統計の出力
```

## データモデル

### 実行設定モデル

```bash
# 環境変数として管理される設定
DEPLOY_ENV="preview|prod"          # デプロイ環境
SKIP_DATA_COLLECTION="true|false"  # データ収集スキップフラグ
VERBOSE_MODE="true|false"          # 詳細ログモード
BACKUP_ENABLED="true|false"        # バックアップ作成フラグ
LOG_LEVEL="info|debug|error"       # ログレベル
```

### ログ出力モデル

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "step": "data_collection",
  "status": "running|completed|failed",
  "duration": 120,
  "message": "データ収集を開始しました",
  "details": {
    "articles_collected": 45,
    "summaries_generated": 45,
    "errors": []
  }
}
```

### 統計情報モデル

```json
{
  "execution_summary": {
    "start_time": "2024-01-15T10:30:00Z",
    "end_time": "2024-01-15T10:45:00Z",
    "total_duration": 900,
    "steps": [
      {
        "name": "environment_setup",
        "duration": 5,
        "status": "completed"
      },
      {
        "name": "data_collection",
        "duration": 780,
        "status": "completed"
      },
      {
        "name": "data_copy",
        "duration": 2,
        "status": "completed"
      },
      {
        "name": "vercel_deploy",
        "duration": 113,
        "status": "completed"
      }
    ],
    "data_statistics": {
      "articles_processed": 45,
      "summaries_generated": 45,
      "categories": ["国内", "海外", "Reddit"],
      "sources": ["techcrunch", "oreilly", "reddit"]
    }
  }
}
```

## エラーハンドリング

### エラー分類と対応

1. **環境エラー**
   - 仮想環境が見つからない
   - Python依存関係の不足
   - 対応: セットアップ手順の表示

2. **データ収集エラー**
   - API制限エラー
   - ネットワークエラー
   - 対応: リトライ機能と部分的な継続

3. **ファイル操作エラー**
   - ディスク容量不足
   - 権限エラー
   - 対応: 詳細エラー情報の表示

4. **デプロイエラー**
   - Vercel認証エラー
   - ビルドエラー
   - 対応: ロールバック機能の提供

### エラー回復戦略

```bash
# エラー発生時の処理フロー
1. エラーの分類と記録
2. 可能な場合の自動回復試行
3. ユーザーへの明確なエラー報告
4. 回復手順の提示
5. 必要に応じたロールバック実行
```

## テスト戦略

### 単体テスト

1. **スクリプト単体テスト**
   - 各ユーティリティスクリプトの動作確認
   - 引数解析の正確性テスト
   - エラーハンドリングの検証

2. **環境テスト**
   - 仮想環境検出の正確性
   - 依存関係確認の動作
   - 権限チェックの実行

### 統合テスト

1. **ワークフローテスト**
   - フルデプロイフローの実行
   - データのみフローの実行
   - デプロイのみフローの実行

2. **エラーシナリオテスト**
   - 各ステップでのエラー発生時の動作
   - 中断・再開機能の検証
   - ロールバック機能の確認

### パフォーマンステスト

1. **実行時間測定**
   - 各ステップの実行時間計測
   - 全体ワークフローの時間測定
   - 並列処理可能な部分の特定

2. **リソース使用量測定**
   - CPU使用率の監視
   - メモリ使用量の確認
   - ディスク使用量の測定

## セキュリティ考慮事項

### 認証情報の管理

1. **環境変数の保護**
   - APIキーの安全な取り扱い
   - Vercel認証トークンの管理
   - 機密情報のログ出力防止

2. **ファイル権限の設定**
   - スクリプトファイルの実行権限
   - ログファイルのアクセス制御
   - 一時ファイルの適切な削除

### 入力検証

1. **引数の検証**
   - 不正な環境指定の防止
   - パスインジェクションの防止
   - 特殊文字の適切な処理

2. **ファイルパスの検証**
   - 相対パスの正規化
   - ディレクトリトラバーサルの防止
   - 書き込み権限の確認

## パフォーマンス最適化

### 並列処理の活用

1. **データ処理の並列化**
   - 記事収集の並列実行
   - 要約生成の並列処理
   - ファイル操作の最適化

2. **キャッシュ機能**
   - 依存関係チェックのキャッシュ
   - 環境情報のキャッシュ
   - 前回実行結果の活用

### リソース使用量の最適化

1. **メモリ使用量の削減**
   - 大きなファイルのストリーミング処理
   - 不要な変数の適切な解放
   - 効率的なデータ構造の使用

2. **ディスク使用量の管理**
   - 一時ファイルの適切な削除
   - ログローテーションの実装
   - 古いバックアップの自動削除

## 運用・保守性

### ログ管理

1. **ログレベルの設定**
   - DEBUG: 詳細な実行情報
   - INFO: 一般的な実行情報
   - ERROR: エラー情報のみ

2. **ログローテーション**
   - 日次ログファイルの作成
   - 古いログの自動削除
   - ログサイズの制限

### 監視・アラート

1. **実行状況の監視**
   - 実行時間の異常検知
   - エラー発生率の監視
   - リソース使用量の追跡

2. **アラート機能**
   - 長時間実行の警告
   - エラー発生時の通知
   - ディスク容量不足の警告

## 拡張性

### 新しいステップの追加

1. **プラグイン機能**
   - カスタムステップの追加
   - フック機能の実装
   - 設定ファイルによる制御

2. **外部ツールとの連携**
   - CI/CDパイプラインとの統合
   - 監視ツールとの連携
   - 通知システムとの統合

### 設定の柔軟性

1. **設定ファイル**
   - YAML/JSON形式の設定
   - 環境別設定の管理
   - デフォルト値の提供

2. **コマンドライン引数**
   - 豊富なオプション提供
   - ヘルプ機能の充実
   - 引数の自動補完