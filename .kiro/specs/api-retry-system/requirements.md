# 要件定義書

## 概要

AI記事要約処理において、API制限やその他の一時的なエラーで失敗した記事を自動的にリトライする機能を実装します。これにより、処理成功率を向上させ、より多くの記事を確実に要約できるようになります。

## 要件

### 要件1

**ユーザーストーリー:** システム管理者として、API制限で失敗した記事要約処理を後で自動的にリトライしたい。これにより、一時的なAPI制限による処理失敗を回復できるようになる。

#### 受け入れ基準

1. WHEN API制限エラー（429エラー）が発生した場合 THEN システムは失敗した記事情報をリトライキューに保存する
2. WHEN OpenAI quota exceeded エラーが発生した場合 THEN システムは失敗した記事情報をリトライキューに保存する
3. WHEN Claude API制限エラーが発生した場合 THEN システムは失敗した記事情報をリトライキューに保存する
4. WHEN リトライキューに記事が保存される場合 THEN 記事ID、タイトル、内容、失敗理由、失敗時刻、リトライ回数が記録される

### 要件2

**ユーザーストーリー:** システム管理者として、失敗した記事を指数バックオフでリトライしたい。これにより、API制限が解除されるまで適切な間隔でリトライできるようになる。

#### 受け入れ基準

1. WHEN リトライ処理が実行される場合 THEN 初回リトライは5分後に実行される
2. WHEN リトライが再度失敗した場合 THEN 次のリトライ間隔は前回の2倍になる（指数バックオフ）
3. WHEN リトライ間隔が最大値（24時間）に達した場合 THEN それ以上間隔は延長されない
4. WHEN リトライ回数が最大値（5回）に達した場合 THEN その記事は永続的失敗として記録される

### 要件3

**ユーザーストーリー:** システム管理者として、リトライキューの状態を監視したい。これにより、システムの処理状況を把握し、必要に応じて手動介入できるようになる。

#### 受け入れ基準

1. WHEN リトライキューが存在する場合 THEN キュー内の記事数がログに出力される
2. WHEN リトライ処理が実行される場合 THEN 処理対象記事数と成功/失敗数がログに出力される
3. WHEN 永続的失敗記事が発生した場合 THEN 警告ログが出力される
4. WHEN リトライキューが空になった場合 THEN 完了ログが出力される

### 要件4

**ユーザーストーリー:** システム管理者として、リトライ処理を手動で実行したい。これにより、API制限が解除されたタイミングで即座にリトライを実行できるようになる。

#### 受け入れ基準

1. WHEN 手動リトライコマンドが実行された場合 THEN リトライキュー内のすべての記事が処理される
2. WHEN 手動リトライが実行された場合 THEN 指数バックオフの待機時間は無視される
3. WHEN 手動リトライで成功した記事がある場合 THEN その記事はキューから削除される
4. WHEN 手動リトライで失敗した記事がある場合 THEN リトライ回数が増加し、次回の自動リトライ時刻が更新される

### 要件5

**ユーザーストーリー:** システム管理者として、リトライキューのデータを永続化したい。これにより、システム再起動後もリトライ処理を継続できるようになる。

#### 受け入れ基準

1. WHEN リトライキューに記事が追加された場合 THEN データはJSONファイルに保存される
2. WHEN システムが起動した場合 THEN 既存のリトライキューファイルが読み込まれる
3. WHEN リトライキューファイルが存在しない場合 THEN 新しい空のキューが作成される
4. WHEN リトライキューが更新された場合 THEN ファイルが即座に更新される

### 要件6

**ユーザーストーリー:** システム管理者として、異なるAIプロバイダー間でのフォールバック機能を利用したい。これにより、一つのプロバイダーが制限に達した場合でも、別のプロバイダーで処理を継続できるようになる。

#### 受け入れ基準

1. WHEN OpenAIでAPI制限エラーが発生した場合 THEN Claudeでの処理を試行する
2. WHEN Claudeでエラーが発生した場合 THEN OpenAIでの処理を試行する
3. WHEN 両方のプロバイダーで失敗した場合 THEN 記事をリトライキューに追加する
4. WHEN フォールバック処理が成功した場合 THEN 成功したプロバイダー名がログに記録される