# 実装計画

- [x] 1. 基本データ構造とストレージの実装
  - RetryQueueItemとRetryQueueのデータクラスを作成
  - JSON形式でのシリアライゼーション/デシリアライゼーション機能を実装
  - _要件: 1.4, 5.1, 5.2, 5.3, 5.4_

- [x] 1.1 RetryQueueItemデータクラスの実装
  - 失敗記事の情報を格納するデータクラスを作成
  - 期限切れチェックとリトライ可能チェックのメソッドを実装
  - _要件: 1.4_

- [x] 1.2 RetryQueueデータクラスの実装
  - リトライキュー全体を管理するデータクラスを作成
  - アクティブアイテムとリトライ候補の取得メソッドを実装
  - _要件: 1.4_

- [x] 1.3 RetryStorageクラスの実装
  - JSONファイルへの保存・読み込み機能を実装
  - ファイルロックとエラーハンドリングを追加
  - 古いエントリのクリーンアップ機能を実装
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 2. エラー分類とリトライ判定の実装
  - API制限エラーやネットワークエラーを識別する機能を作成
  - エラーメッセージから構造化された失敗理由を抽出する機能を実装
  - _要件: 1.1, 1.2, 1.3_

- [ ] 2.1 ErrorClassifierクラスの実装
  - リトライ可能エラーの判定ロジックを実装
  - OpenAI、Claude、Gemini各プロバイダーのエラーパターンを定義
  - 失敗理由の構造化抽出機能を実装
  - _要件: 1.1, 1.2, 1.3_

- [ ] 2.2 エラー分類のテストケース作成
  - 各種APIエラーレスポンスのテストデータを作成
  - エラー分類ロジックの単体テストを実装
  - _要件: 1.1, 1.2, 1.3_

- [ ] 3. RetryQueueManagerの実装
  - 失敗記事をキューに追加する機能を実装
  - リトライ対象記事の取得と状態更新機能を作成
  - _要件: 1.4, 3.1, 3.2_

- [ ] 3.1 基本的なキュー管理機能の実装
  - add_failed_article()メソッドで失敗記事をキューに追加
  - get_retry_candidates()メソッドでリトライ対象を取得
  - mark_success()とmark_failure()メソッドで状態を更新
  - _要件: 1.4_

- [ ] 3.2 キュー監視とログ機能の実装
  - キュー内記事数のログ出力機能を実装
  - 永続的失敗記事の警告ログ機能を追加
  - キュー空状態の完了ログ機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 4. 指数バックオフスケジューラーの実装
  - リトライ間隔を指数的に増加させる機能を作成
  - 最大間隔と最大回数の制限を実装
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 4.1 RetrySchedulerクラスの実装
  - calculate_backoff_delay()メソッドで指数バックオフ遅延を計算
  - 初回5分、最大24時間の制限を実装
  - 最大リトライ回数5回の制限を実装
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 4.2 スケジュール実行機能の実装
  - execute_scheduled_retries()メソッドでスケジュールされたリトライを実行
  - 非同期でのリトライ処理を実装
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 5. MultiAISummarizerとの統合
  - 既存のエラーハンドリングにリトライキュー追加機能を統合
  - プロバイダー間フォールバック失敗時のキュー追加を実装
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 5.1 summarize_article()メソッドの拡張
  - 既存のプロバイダーフォールバック処理を維持
  - 全プロバイダー失敗時にリトライキューへ追加する機能を実装
  - _要件: 6.1, 6.2, 6.3_

- [ ] 5.2 batch_process()メソッドの拡張
  - バッチ処理での失敗記事をリトライキューに追加
  - 成功記事と失敗記事の分離処理を実装
  - _要件: 6.1, 6.2, 6.3_

- [ ] 5.3 process_retry_queue()メソッドの追加
  - リトライキューからの記事処理機能を実装
  - 既存のプロバイダー選択ロジックを再利用
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 6. 手動リトライ機能の実装
  - 即座にリトライを実行する機能を作成
  - リトライキューの状態を確認する機能を実装
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 6.1 ManualRetryHandlerクラスの実装
  - retry_all()メソッドで全記事の手動リトライを実装
  - retry_by_provider()メソッドで特定プロバイダーの記事をリトライ
  - get_retry_status()メソッドでキュー状態を取得
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 6.2 CLIコマンドの実装
  - 手動リトライを実行するCLIコマンドを作成
  - キュー状態を表示するCLIコマンドを実装
  - _要件: 4.1, 4.3_

- [ ] 7. メインパイプラインとの統合
  - 既存のProcessingPipelineにリトライ処理を統合
  - 起動時のリトライキュー読み込みを実装
  - _要件: 5.2, 5.3_

- [ ] 7.1 ProcessingPipelineクラスの拡張
  - initialize_components()でリトライマネージャーを初期化
  - run()メソッドにリトライキュー処理を追加
  - _要件: 5.2_

- [ ] 7.2 起動時リトライキュー処理の実装
  - システム起動時に既存のリトライキューを読み込み
  - 処理可能なリトライ候補があれば自動実行
  - _要件: 5.2, 5.3_

- [ ] 8. 設定管理の実装
  - リトライ関連設定をAppConfigに追加
  - 環境変数からの設定読み込みを実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 5.4_

- [ ] 8.1 RetryConfigクラスの実装
  - リトライ設定のデータクラスを作成
  - デフォルト値と環境変数からの読み込みを実装
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 8.2 AppConfigクラスの拡張
  - 既存のAppConfigにRetryConfigを統合
  - .envファイルからのリトライ設定読み込みを実装
  - _要件: 5.4_

- [ ] 9. 包括的テストの実装
  - 単体テスト、統合テスト、エンドツーエンドテストを作成
  - モックを使用したAPI制限エラーのシミュレーションテストを実装
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 9.1 RetryQueueManagerの単体テスト
  - キュー追加、取得、状態更新の各機能をテスト
  - エラーケースとエッジケースのテストを実装
  - _要件: 1.4, 3.1, 3.2, 3.3, 3.4_

- [ ] 9.2 RetrySchedulerの単体テスト
  - 指数バックオフ計算の正確性をテスト
  - スケジュール実行のタイミングテストを実装
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ] 9.3 統合テストの実装
  - 実際のAPI制限エラーをシミュレートした統合テスト
  - プロバイダーフォールバック + リトライの統合テスト
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 10. 監視とメトリクス機能の実装
  - リトライキューの状態監視機能を作成
  - 成功率やエラー傾向の分析機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 10.1 RetryMetricsCollectorの実装
  - リトライ関連メトリクスの収集機能を実装
  - キューサイズ、成功率、平均リトライ回数の追跡
  - _要件: 3.1, 3.2_

- [ ] 10.2 ダッシュボード統合
  - 既存の監視ダッシュボードにリトライ情報を追加
  - リアルタイムキュー状況の表示機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4_